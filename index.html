<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open Source Government Transcripts</title>

  <!-- Fonts (Myanmar + base) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Myanmar:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #0e1116;
      --surface: #151a22;
      --elev: #1b212c;
      --card: #1a1f29;
      --border: #2a3140;
      --text: #e7eaf0;
      --text-dim: #9aa4b2;
      --muted: #8a94a2;
      --accent: #2f81f7; /* blue, no purple */
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Myanmar Text', 'Noto Sans Myanmar', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container { max-width: 1120px; margin: 36px auto 72px; padding: 0 20px; }
    .header { text-align: center; margin-bottom: 20px; position: relative; }
    .header h1 {
      font-family: 'Myanmar Text', 'Noto Sans Myanmar', sans-serif;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: clamp(2rem, 3.4vw, 3rem);
      color: var(--text);
    }
    .header p { color: var(--text-dim); }

    .controls {
      display: flex; gap: 14px; flex-wrap: wrap; align-items: end;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }
    .control-group { display: flex; flex-direction: column; gap: 8px; min-width: 220px; }
    label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); }
    input[type="text"], input[type="url"], select {
      background: var(--elev); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: var(--radius-md); outline: none;
    }
    input::placeholder { color: #7f8aa0; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.25); }

    button, .btn-small, .btn-primary, .btn-secondary {
      border: none; border-radius: var(--radius-md);
      padding: 11px 14px; font-weight: 650; cursor: pointer;
      transition: transform .06s ease, filter .15s ease;
      font-family: 'Myanmar Text', 'Noto Sans Myanmar', sans-serif;
    }
    .btn-primary, button { background: var(--accent); color: #0b0f17; }
    .btn-secondary { background: #233044; color: var(--text); border: 1px solid var(--border); }
    button:hover, .btn-small:hover, .btn-primary:hover, .btn-secondary:hover { transform: translateY(-1px); filter: brightness(1.05); }

    .filters { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0 16px; align-items: center; }
    .filter-chip {
      background: #1d2430; border: 1px solid var(--border); color: var(--text);
      padding: 8px 12px; border-radius: 999px; font-weight: 600; font-size: 0.9rem; cursor: pointer;
    }
    .filter-chip.active { background: var(--accent); color: #0b0f17; border-color: transparent; }

    .grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .card, .transcript-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 16px; box-shadow: var(--shadow);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .board-type { background: #0f1724; color: #bcd3ff; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 0.8rem; border: 1px solid #24314b; }
    .date { color: var(--text-dim); font-size: 0.9rem; }
    .card-title { font-family: 'Myanmar Text', 'Noto Sans Myanmar', sans-serif; font-weight: 800; margin: 4px 0 8px; font-size: 1.2rem; color: var(--text); }
    .card-description { color: var(--text-dim); font-size: 0.95rem; }
    .card-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

    .status { display: none; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--surface); color: var(--text); margin: 14px 0; }
    .status.info { border-color: #2f81f733; }
    .status.error { border-color: #ff6b6b55; }
    .status.success { border-color: #34d39955; }

    .empty-state { text-align: center; border: 1px dashed var(--border); background: var(--surface); color: var(--text-dim); padding: 26px; border-radius: var(--radius-lg); }

    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); z-index: 1000; padding: 24px; }
    .modal.active { display: grid; }
    .modal-content { width: min(900px, 96vw); background: var(--card); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; box-shadow: var(--shadow); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 18px; background: #131822; border-bottom: 1px solid var(--border); }
    .modal-title { font-family: 'Myanmar Text','Noto Sans Myanmar',sans-serif; font-weight: 800; font-size: 1.3rem; color: var(--text); }
    .close-modal { background: transparent; color: var(--text-dim); border: 1px solid var(--border); padding: 6px 10px; border-radius: var(--radius-sm); cursor: pointer; }
    .transcript-content { padding: 18px; color: var(--text); }
    pre { background: #0f1420; border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-md); padding: 16px; overflow: auto; }

    /* Loading */
    .loading { display: none; align-items: center; gap: 10px; }
    .loading.active { display: flex; }
    .spinner { width: 20px; height: 20px; border-radius: 50%; border: 3px solid #3b485d; border-top-color: var(--accent); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Light theme */
    [data-theme="light"]{
      --bg: #f6f8fb;
      --surface: #ffffff;
      --elev: #f2f4f8;
      --card: #ffffff;
      --border: #e3e8ef;
      --text: #0e1320;
      --text-dim: #404a5a;
      --muted: #5a6575;
      --accent: #2f81f7;
    }

    /* Ads & Sponsor */
    .ad-card{ display:block; }
    .sponsor-fallback{ display:flex; gap:14px; align-items:center; }
    .sponsor-fallback .sponsor-badge{ background:#0f1724; color:#bcd3ff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.8rem; border:1px solid #24314b; }
    .sponsor-fallback .sponsor-title{ font-weight:800; font-size:1.05rem; margin:2px 0 4px; }
    .sponsor-fallback .sponsor-desc{ color: var(--text-dim); font-size:.95rem; }
  </style>

  <!-- Third‚Äëparty libs (load only the libraries here) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <button id="themeToggle" class="btn-secondary" style="position:absolute; right:20px; top:0;">üåó Theme</button>
      <h1>Open Source Government Transcripts</h1>
      <p>Organized access to municipal meeting records and discussions</p>
    </div>

    <div class="controls">
      <div class="control-group">
        <label for="townInput">Town / City</label>
        <input type="text" id="townInput" placeholder="e.g., Nantucket" />
      </div>
      <div class="control-group">
        <label for="stateInput">State</label>
        <input list="usStates" id="stateInput" placeholder="e.g., Massachusetts" />
        <datalist id="usStates">
          <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option>
          <option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option>
          <option>District of Columbia</option><option>Florida</option><option>Georgia</option><option>Hawaii</option>
          <option>Idaho</option><option>Illinois</option><option>Indiana</option><option>Iowa</option>
          <option>Kansas</option><option>Kentucky</option><option>Louisiana</option><option>Maine</option>
          <option>Maryland</option><option>Massachusetts</option><option>Michigan</option><option>Minnesota</option>
          <option>Mississippi</option><option>Missouri</option><option>Montana</option><option>Nebraska</option>
          <option>Nevada</option><option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option>
          <option>New York</option><option>North Carolina</option><option>North Dakota</option><option>Ohio</option>
          <option>Oklahoma</option><option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option>
          <option>South Carolina</option><option>South Dakota</option><option>Tennessee</option><option>Texas</option>
          <option>Utah</option><option>Vermont</option><option>Virginia</option><option>Washington</option>
          <option>West Virginia</option><option>Wisconsin</option><option>Wyoming</option>
        </datalist>
      </div>

      <div class="control-group">
        <label for="channelUrl">YouTube Channel URL:</label>
        <input type="url" id="channelUrl" placeholder="https://youtube.com/@TownofNantucket" value="https://youtube.com/@TownofNantucket" />
      </div>

      <div class="control-group">
        <label for="dateRange">Date Range:</label>
        <select id="dateRange">
          <option value="30">Last 30 days</option>
          <option value="90">Last 3 months</option>
          <option value="365">Last year</option>
          <option value="all">All time</option>
        </select>
      </div>

      <div class="control-group" style="flex:1; min-width: 260px;">
        <label for="searchInput">Search Transcripts:</label>
        <input type="text" id="searchInput" placeholder="Search titles, content..." />
      </div>

      <button id="btnFindChannel">üõ∞Ô∏è Find Channel</button>
      <button id="btnFetch">üîç Fetch Transcripts</button>
      <button id="btnExport">üìä Export Data</button>
    </div>

    <div id="status" class="status info" style="display: none;">Ready to fetch transcripts. Click "Fetch Transcripts" to begin.</div>

    <div class="filters" id="boardFilters">
      <div class="filter-chip active" data-board="all">All Boards</div>
      <!-- Tasteful top ad / sponsor slot -->
      <div class="card ad-card" id="adTop" aria-label="Sponsored">
        <ins class="adsbygoogle" style="display:block; min-height: 120px" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="NNNNNNNNNN" data-ad-format="auto" data-full-width-responsive="true"></ins>
      </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div><p>Fetching and processing transcripts...</p></div>

    <div class="grid" id="transcriptGrid">
      <div class="empty-state">
        <h3>No transcripts loaded yet</h3>
        <p>Use the controls above to fetch transcripts from the Nantucket town channel.</p>
      </div>
    </div>
  </div>

  <!-- Channel chooser modal -->
  <div class="modal" id="channelModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Select a Channel</h2>
        <button class="close-modal" onclick="closeChannelModal()">&times;</button>
      </div>
      <div class="transcript-content" id="channelCandidates"></div>
    </div>
  </div>

  <!-- Transcript modal -->
  <div class="modal" id="transcriptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Transcript</h2>
        <div class="card-actions">
          <button class="btn-secondary" id="btnGenMinutes" title="Generate Minutes">üìù Generate Minutes</button>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
      </div>
      <div class="transcript-content" id="modalContent">
        <!-- Injected -->
      </div>
    </div>
  </div>

  <!-- Minutes modal -->
  <div class="modal" id="minutesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Generated Minutes (Draft)</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="minutesSaveStatus" style="color:var(--text-dim); font-size:.85rem; margin-right:6px;"></span>
          <button class="btn-secondary" onclick="copyMinutes()">Copy</button>
          <button class="btn-secondary" onclick="exportMinutesDocx()">Export .docx</button>
          <button class="btn-secondary" onclick="exportMinutesPdf()">Export .pdf</button>
          <button class="btn-primary" onclick="downloadMinutes()">Download .md</button>
          <button class="close-modal" onclick="closeMinutesModal()">&times;</button>
        </div>
      </div>
      <div class="transcript-content">
        <textarea id="minutesText" style="width:100%; min-height:420px; background:var(--elev); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:14px; font-family:inherit;"></textarea>
      </div>
    </div>
  </div>

  <script>
    // ========= Config =========
    // IMPORTANT: For production, do not expose keys client-side. Route via /.netlify/functions.
    const YOUTUBE_API_KEY = 'PASTE_YOUR_API_KEY_HERE'; // Replace or proxy via serverless
    const BACKEND_URL = '/.netlify/functions/youtube-api';

    // ========= State =========
    let transcripts = [];
    let currentFilter = 'all';
    let useRealAPI = !!YOUTUBE_API_KEY && YOUTUBE_API_KEY !== 'PASTE_YOUR_API_KEY_HERE';
    let lastViewedTranscriptId = null;

    // ========= Ads fallback =========
    function renderSponsorFallback(container = document) {
      container.querySelectorAll('.ad-card').forEach((card) => {
        if (card.dataset.filled === '1') return;
        const fallback = document.createElement('div');
        fallback.className = 'sponsor-fallback';
        fallback.innerHTML = `
          <div class="sponsor-badge">Sponsored</div>
          <div style="flex:1">
            <div class="sponsor-title">Support Open Source Government Transcripts</div>
            <div class="sponsor-desc">Help keep meeting data searchable and accessible for everyone.</div>
            <div class="card-actions" style="margin-top:8px;">
              <a class="btn-primary" href="/sponsor-info" target="_blank" rel="noopener">Become a Sponsor</a>
              <a class="btn-secondary" href="/privacy" target="_blank" rel="noopener">Privacy</a>
            </div>
          </div>`;
        card.innerHTML = '';
        card.appendChild(fallback);
        card.dataset.filled = '1';
      });
    }
    function refreshAds(container = document) {
      const units = container.querySelectorAll('ins.adsbygoogle');
      if (!units.length) return;
      if (window.adsbygoogle && Array.isArray(window.adsbygoogle)) {
        units.forEach(() => {
          try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}
        });
      } else {
        setTimeout(() => {
          if (!(window.adsbygoogle && Array.isArray(window.adsbygoogle))) {
            renderSponsorFallback(container);
          }
        }, 1200);
      }
    }

    // ========= UI helpers =========
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
    }
    function showLoading(show = true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    // Theme toggle with persistence
    (function () {
      const root = document.documentElement;
      const saved = localStorage.getItem('osgt_theme');
      if (saved === 'light') root.setAttribute('data-theme', 'light');
      const btn = document.getElementById('themeToggle');
      if (btn) {
        btn.addEventListener('click', () => {
          const isLight = root.getAttribute('data-theme') === 'light';
          root.setAttribute('data-theme', isLight ? '' : 'light');
          localStorage.setItem('osgt_theme', isLight ? 'dark' : 'light');
          btn.textContent = root.getAttribute('data-theme') === 'light' ? 'üåô Dark' : 'üåû Light';
        });
        btn.textContent = root.getAttribute('data-theme') === 'light' ? 'üåô Dark' : 'üåû Light';
      }
    })();

    // ========= App logic =========
    function extractChannelInfo(url) {
      const patterns = [
        /youtube\.com\/@([^/\?&]+)/, // handle
        /youtube\.com\/c\/([^/\?&]+)/, // custom
        /youtube\.com\/channel\/([^/\?&]+)/, // id
        /youtube\.com\/user\/([^/\?&]+)/, // legacy
      ];
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return { identifier: match[1], type: url.includes('/channel/') ? 'id' : url.includes('/@') ? 'handle' : 'username' };
        }
      }
      return null;
    }

    function calculateDateFilter(range) {
      const now = new Date();
      const daysBack = range === 'all' ? 365 * 5 : parseInt(range, 10);
      const cutoffDate = new Date(now.getTime() - daysBack * 24 * 60 * 60 * 1000);
      return cutoffDate.toISOString();
    }

    function formatDuration(iso) {
      const m = iso && iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!m) return 'Unknown';
      const h = parseInt(m[1] || '0', 10), mm = parseInt(m[2] || '0', 10), ss = parseInt(m[3] || '0', 10);
      return h > 0 ? `${h}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}` : `${mm}:${String(ss).padStart(2, '0')}`;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    async function getChannelIdFromHandle(handle) {
      const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(handle)}&maxResults=1&key=${YOUTUBE_API_KEY}`;
      const res = await fetch(searchUrl);
      const data = await res.json();
      if (data.items && data.items[0]) return data.items[0].snippet.channelId;
      throw new Error('Channel not found');
    }

    async function fetchChannelVideos(channelInfo, dateRange) {
      if (!useRealAPI) {
        return generateMockVideos('nantucket town meeting', new Date('2023-01-01'));
      }
      try {
        let channelId = channelInfo.identifier;
        if (channelInfo.type !== 'id') channelId = await getChannelIdFromHandle(channelInfo.identifier);
        const publishedAfter = calculateDateFilter(dateRange);
        const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&order=date&maxResults=50&publishedAfter=${publishedAfter}&key=${YOUTUBE_API_KEY}`;
        const searchResponse = await fetch(searchUrl);
        if (!searchResponse.ok) throw new Error(`YouTube API error: ${searchResponse.statusText}`);
        const searchData = await searchResponse.json();
        if (!searchData.items || !searchData.items.length) throw new Error('No videos found for this channel');
        const videoIds = searchData.items.map((it) => it.id.videoId).join(',');
        const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
        const detailsResponse = await fetch(detailsUrl);
        const detailsData = await detailsResponse.json();
        const townMeetingVideos = detailsData.items.filter((v) => {
          const t = v.snippet.title.toLowerCase();
          const d = (v.snippet.description || '').toLowerCase();
          return t.includes('meeting') || t.includes('board') || t.includes('committee') || t.includes('town') || d.includes('meeting') || d.includes('board');
        });
        return townMeetingVideos.map((v) => ({
          videoId: v.id,
          title: v.snippet.title,
          description: v.snippet.description || 'No description available',
          publishedAt: v.snippet.publishedAt,
          thumbnailUrl: v.snippet.thumbnails.high?.url || v.snippet.thumbnails.default?.url,
          duration: formatDuration(v.contentDetails.duration),
          viewCount: parseInt(v.statistics.viewCount || '0', 10),
        }));
      } catch (e) {
        console.warn('Error fetching real videos, using mock:', e);
        showStatus('Using demo data - add your YouTube API key for real data', 'info');
        return generateMockVideos('nantucket town meeting', new Date('2023-01-01'));
      }
    }

    function generateVideoTitle(boardType, date) {
      const titles = {
        'Select Board': ['Select Board Meeting', 'Nantucket Select Board Regular Meeting', 'Select Board Public Session', 'Town of Nantucket Select Board Meeting'],
        'Planning Board': ['Planning Board Meeting', 'Nantucket Planning Board Session', 'Planning Board Public Hearing', 'Town Planning Board Review'],
        'School Committee': ['School Committee Meeting', 'Nantucket School Committee Session', 'Public Schools Committee Meeting', 'Education Committee Discussion'],
        'Town Meeting': ['Annual Town Meeting', 'Special Town Meeting', 'Nantucket Town Meeting', 'Public Town Session'],
      };
      const base = titles[boardType][Math.floor(Math.random() * titles[boardType].length)];
      const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      return `${base} - ${monthYear}`;
    }
    function generateVideoDescription(boardType) {
      const desc = {
        'Select Board': 'Regular meeting of the Nantucket Select Board addressing municipal matters, budget discussions, and public concerns.',
        'Planning Board': 'Nantucket Planning Board meeting reviewing development proposals, zoning changes, and land use matters.',
        'School Committee': 'Nantucket School Committee meeting discussing educational policies, budget matters, and student programs.',
        'Town Meeting': 'Public town meeting for Nantucket residents to discuss and vote on municipal issues and budget items.',
      };
      return desc[boardType] || 'Town of Nantucket public meeting recording.';
    }
    function generateMockVideos(searchTerm, cutoffDate) {
      const boardTypes = { 'select board': 'Select Board', 'planning board': 'Planning Board', 'school committee': 'School Committee', 'town meeting': 'Town Meeting' };
      const boardType = Object.keys(boardTypes).find((k) => searchTerm.toLowerCase().includes(k)) || 'town meeting';
      const bt = boardTypes[boardType] || 'Town Meeting';
      const videos = [];
      const videoCount = Math.floor(Math.random() * 8) + 3;
      for (let i = 0; i < videoCount; i++) {
        const daysAgo = Math.floor(Math.random() * 180);
        const d = new Date();
        d.setDate(d.getDate() - daysAgo);
        if (d >= cutoffDate) {
          const id = `mock_${Date.now()}_${i}`;
          videos.push({
            videoId: id,
            title: generateVideoTitle(bt, d),
            description: generateVideoDescription(bt),
            publishedAt: d.toISOString(),
            thumbnailUrl: `https://img.youtube.com/vi/${id}/hqdefault.jpg`,
            duration: `${Math.floor(Math.random() * 120) + 30}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
            viewCount: Math.floor(Math.random() * 1000) + 50,
          });
        }
      }
      return videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
    }

    function extractBoardType(title) {
      const boardPatterns = {
        'Select Board': /select\s+board/i,
        'Planning Board': /planning\s+board/i,
        'School Committee': /school\s+committee/i,
        'Conservation Commission': /conservation/i,
        'Zoning Board': /zoning/i,
        'Finance Committee': /finance/i,
      };
      for (const [board, pattern] of Object.entries(boardPatterns)) if (pattern.test(title)) return board;
      return 'Town Meeting';
    }

    async function processVideoTranscript(video) {
      const boardType = extractBoardType(video.title);
      let transcript;
      if (useRealAPI) {
        try {
          const response = await fetch(`${BACKEND_URL}/api/transcript/${video.videoId}`);
          const data = await response.json();
          transcript = data.success ? data.transcript : generateMockTranscript(video, boardType);
        } catch { transcript = generateMockTranscript(video, boardType); }
      } else {
        transcript = generateMockTranscript(video, boardType);
      }
      return { id: video.videoId, title: video.title, date: video.publishedAt.split('T')[0], board: boardType, videoId: video.videoId, description: video.description, transcript, duration: video.duration, viewCount: video.viewCount, thumbnailUrl: video.thumbnailUrl };
    }

    function generateMockTranscript(video, boardType) {
      const map = {
        'Select Board': () => `[#] CHAIRPERSON: Good evening, everyone. This is the Select Board meeting for ${new Date(video.publishedAt).toLocaleDateString()}.
[00:01:30] CHAIRPERSON: We'll begin with the approval of minutes.
[00:05:00] BOARD MEMBER: I move to approve the minutes as presented.
[00:05:15] BOARD MEMBER: Second.
[00:08:00] CHAIRPERSON: Budget discussion for the upcoming fiscal year.
[00:10:30] TOWN ADMINISTRATOR: The proposed budget shows an increase of 3.2%.
[00:45:00] PUBLIC COMMENT: Residents speak on priorities.
[01:25:00] CHAIRPERSON: Meeting adjourned.`,
        'Planning Board': () => `[00:00:00] CHAIR: Planning Board meeting called to order at 7:00 PM.
[00:02:00] Application #2024-001 at 123 Main Street.
[00:30:00] PUBLIC COMMENT: Concerns about parking.
[01:05:00] Motion carries 4-1. Meeting adjourned.`,
        'School Committee': () => `[00:00:00] SUPERINTENDENT: Welcome to tonight's School Committee meeting.
[00:05:00] Enrollment stands at 1,247 students.
[00:55:00] PUBLIC COMMENT: After-school programs discussed.
[01:15:00] Next meeting next month.`,
        'Town Meeting': () => `[00:00:00] MODERATOR: Town Meeting called to order.
[00:45:00] Article 2: Budget appropriations.
[02:45:00] Motion carries. Meeting adjourned.`,
      };
      const gen = map[boardType] || map['Town Meeting'];
      return gen();
    }

    function updateBoardFilters() {
      const boards = [...new Set(transcripts.map((t) => t.board))];
      const filtersEl = document.getElementById('boardFilters');
      filtersEl.innerHTML = '<div class="filter-chip active" data-board="all">All Boards</div>';
      boards.forEach((board) => {
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        chip.dataset.board = board;
        chip.textContent = board;
        chip.onclick = () => filterByBoard(board);
        filtersEl.appendChild(chip);
      });
      // re-add ad slot
      const ad = document.createElement('div');
      ad.className = 'card ad-card';
      ad.setAttribute('aria-label', 'Sponsored');
      ad.innerHTML = '<ins class="adsbygoogle" style="display:block; min-height:120px" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="NNNNNNNNNN" data-ad-format="auto" data-full-width-responsive="true"></ins>';
      filtersEl.appendChild(ad);
      refreshAds(document);
    }

    function filterByBoard(board) {
      currentFilter = board;
      document.querySelectorAll('.filter-chip').forEach((chip) => chip.classList.toggle('active', chip.dataset.board === board));
      renderTranscripts();
    }

    function renderTranscripts() {
      const grid = document.getElementById('transcriptGrid');
      let data = transcripts;
      if (currentFilter !== 'all') data = transcripts.filter((t) => t.board === currentFilter);
      if (!data.length) {
        grid.innerHTML = `<div class="empty-state"><h3>No transcripts found</h3><p>No transcripts match your current filter criteria.</p></div>`;
        return;
      }
      data.sort((a, b) => new Date(b.date) - new Date(a.date));
      grid.innerHTML = data
        .map(
          (t) => `
          <div class="transcript-card">
            <div class="card-header">
              <div class="board-type">${t.board}</div>
              <div class="date">${formatDate(t.date)}</div>
            </div>
            <h3 class="card-title">${t.title}</h3>
            <p class="card-description">${t.description}</p>
            <div style="display:flex; gap:10px; align-items:center; margin:10px 0; font-size:0.85rem; color:#6c757d;">
              <span>‚è±Ô∏è ${t.duration || 'N/A'}</span>
              <span>üëÅÔ∏è ${t.viewCount || 0} views</span>
            </div>
            <div class="card-actions">
              <button class="btn-small btn-primary" onclick="viewTranscript('${t.id}')">üìÑ View Transcript</button>
              <a class="btn-small btn-secondary" href="https://youtube.com/watch?v=${t.videoId}" target="_blank" rel="noopener">‚ñ∂Ô∏è Watch Video</a>
              <button class="btn-small btn-secondary" onclick="downloadTranscript('${t.id}')">üíæ Download</button>
            </div>
          </div>`
        )
        .join('');
    }

    // ========= Transcript modal =========
    function viewTranscript(transcriptId) {
      const t = transcripts.find((x) => x.id === transcriptId);
      if (!t) return;
      lastViewedTranscriptId = t.id;
      const body = `
        <div style="margin-bottom: 12px;">
          <strong>Board:</strong> ${t.board}<br/>
          <strong>Date:</strong> ${formatDate(t.date)}<br/>
          <strong>Description:</strong> ${t.description}
        </div>
        <div class="card-actions" id="t-actions" style="margin: 6px 0 10px;"></div>
        <div id="t-jumps" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;"></div>
        <hr style="margin: 14px 0; border: none; border-top: 1px solid var(--border);" />
        <pre id="t-body" style="white-space: pre-wrap; background: var(--elev); padding: 20px; border-radius: 10px;">${(t.transcript || '')}</pre>`;
      document.getElementById('modalTitle').textContent = t.title;
      document.getElementById('modalContent').innerHTML = body;
      document.getElementById('transcriptModal').classList.add('active');

      // Quick-jump buttons
      const lines = (t.transcript || '').split(/\n+/);
      const stamps = extractTimestampLines(lines).slice(0, 15);
      const wrap = document.getElementById('t-jumps');
      wrap.innerHTML = '';
      stamps.forEach((s) => {
        const sec = toSeconds(s.ts);
        if (sec == null) return;
        const a = document.createElement('a');
        a.href = `https://youtube.com/watch?v=${t.videoId}&t=${sec}s`;
        a.target = '_blank'; a.rel = 'noopener'; a.className = 'btn-secondary'; a.textContent = s.ts;
        wrap.appendChild(a);
      });
    }
    function closeModal() { document.getElementById('transcriptModal').classList.remove('active'); }
    // click outside to close
    document.getElementById('transcriptModal').addEventListener('click', (e) => { if (e.target.id === 'transcriptModal') closeModal(); });

    function downloadTranscript(transcriptId) {
      const t = transcripts.find((x) => x.id === transcriptId);
      if (!t) return;
      const content = `# ${t.title}\nDate: ${formatDate(t.date)}\nBoard: ${t.board}\nVideo: https://youtube.com/watch?v=${t.videoId}\n\n## Description\n${t.description}\n\n## Transcript\n${t.transcript}\n`;
      const blob = new Blob([content], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${t.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_transcript.md`; a.click(); URL.revokeObjectURL(url);
    }

    // ========= Minutes (draft) =========
    let __minutesCurrent = null;
    function closeMinutesModal() { document.getElementById('minutesModal').classList.remove('active'); }
    function openMinutesModal() { document.getElementById('minutesModal').classList.add('active'); }
    function copyMinutes() { const el = document.getElementById('minutesText'); el.select(); document.execCommand('copy'); showStatus('Minutes copied to clipboard.', 'success'); }
    function downloadMinutes() { const el = document.getElementById('minutesText'); const blob = new Blob([el.value], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${(__minutesCurrent?.title || 'minutes')}.md`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    function toSeconds(ts) {
      const m = ts.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
      if (!m) return null; const h = m[3] ? parseInt(m[1], 10) : 0; const mm = m[3] ? parseInt(m[2], 10) : parseInt(m[1], 10); const ss = m[3] ? parseInt(m[3], 10) : parseInt(m[2], 10); return h * 3600 + mm * 60 + ss;
    }
    function extractTimestampLines(lines) {
      const out = []; for (const ln of lines) { const m = ln.match(/\b(\d{1,2}:\d{2}(?::\d{2})?)\b/); if (m) out.push({ ts: m[1], text: ln.trim() }); if (out.length >= 30) break; } return out;
    }

    function normalize(s){ return (s||'').replace(/\s+/g,' ').trim(); }
    const STOP = new Set('a,an,the,and,or,but,if,then,else,for,of,in,on,to,from,by,with,at,as,is,are,was,were,be,been,being,that,this,these,those,it,its,into,about,over,under,between,after,before,not,no,yes,you,we,they,he,she,them,him,her,our,your,do,does,did,will,would,can,could,may,might,should,shall,there,here,also'.split(','));

    function extractKeywords(text, k = 8){ const words = text.toLowerCase().replace(/[^a-z0-9\s-]/g, ' ').split(/\s+/).filter(w=>w && w.length>3 && !STOP.has(w)); const freq = new Map(); for (const w of words) freq.set(w,(freq.get(w)||0)+1); return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,k).map(([w])=>w); }
    function makeBulletSummary(lines, k = 5){ const picks=[]; for (const ln of lines){ const l=ln.trim(); if(!l) continue; if (/(agenda item|discussion|update|report|presentation|review|hearing|public comment)/i.test(l)) picks.push('- '+normalize(l)); else if (/(approved|voted|moved|second|passed|failed|tabled)/i.test(l)) picks.push('- '+normalize(l)); if (picks.length>=k) break; } return picks.join('\n') || '- (No concise summary lines detected)'; }
    function extractMotions(lines){ const motions=[]; for (let i=0;i<lines.length;i++){ const l=lines[i]; if (/\b(motion|moved|move to|seconded|vote|voted|roll call)\b/i.test(l)){ const windowLines=lines.slice(Math.max(0,i-1), Math.min(lines.length, i+2)); const text=normalize(windowLines.join(' ')); let outcome=null; const m=text.match(/\b(passed|approved|failed|tabled|unanimous|\b\d+-\d+\b)\b/i); if(m) outcome=m[0]; motions.push({ text, outcome }); } } const uniq=new Map(); motions.forEach(m=>{ if(!uniq.has(m.text)) uniq.set(m.text,m); }); return Array.from(uniq.values()); }
    function extractActions(lines){ const actions=[]; for (const l of lines){ if (/\b(staff|department|board|chair|town manager|planner|committee)\b.*\b(will|to|prepare|follow up|provide|report back|update)\b/i.test(l)) actions.push(normalize(l)); } const uniq=new Map(); actions.forEach(a=>{ const key=a.toLowerCase().slice(0,100); if(!uniq.has(key)) uniq.set(key,a); }); return Array.from(uniq.values()).slice(0,10); }
    function extractPublicComment(lines){ const out=[]; let seen=false; for(const l of lines){ if(/public comment/i.test(l)){ seen=true; out.push(normalize(l)); continue;} if(seen && l.trim()) out.push(normalize(l)); if(seen && out.length>4) break; } return out; }
    function extractNextMeeting(lines){ for(const l of lines){ const m=l.match(/next meeting(?: is)?(?: scheduled)?(?: for)?[:\s]+(.+)/i); if(m) return normalize(m[1]); } return null; }
    function extractAttendees(lines){ const out=[]; for(const l of lines){ const m=l.match(/present[:\-]\s*(.+)/i) || l.match(/members present[:\-]\s*(.+)/i); if(m){ const names=m[1].split(/,|;|\band\b/i).map(s=>normalize(s)).filter(Boolean); names.forEach(n=>{ if(n && !out.includes(n)) out.push(n); }); } } return out.slice(0,12); }
    function detectAdjourn(lines){ for(const l of lines){ if(/adjourn(ed|ment)?/i.test(l)) return normalize(l); } return null; }

    function makeMinutesDraft(meta, text){
      const date = formatDate(meta.date);
      const board = meta.board || 'Meeting';
      const title = meta.title || `${board} Meeting`;
      const lines = text.split(/\n+/);
      const motions = extractMotions(lines);
      const actions = extractActions(lines);
      const keywords = extractKeywords(text, 10);
      const publicComment = extractPublicComment(lines);
      const nextMeeting = extractNextMeeting(lines);
      const attendees = extractAttendees(lines);
      let md = `# Minutes ‚Äî ${board} (${date})\n\n**Meeting Title:** ${title}\n**Date:** ${date}\n**Board/Body:** ${board}\n**Source Video:** https://youtube.com/watch?v=${meta.videoId}\n\n---\n## Summary (Auto-Generated)\n- Key topics: ${keywords.join(', ') || '‚Äî'}\n${makeBulletSummary(lines, 6)}\n\n## Motions & Votes\n${motions.length ? motions.map((m,i)=>`- ${i+1}. ${m.text} ${m.outcome?`**Outcome:** ${m.outcome}`:''}`).join('\n') : '- None detected'}\n\n## Action Items\n${actions.length ? actions.map(a=>`- ${a}`).join('\n') : '- None detected'}\n\n## Public Comment\n${publicComment.length ? publicComment.map(s=>`- ${s}`).join('\n') : '- Not explicitly detected'}\n\n## Attendance (if mentioned)\n${attendees.length ? attendees.map(n=>`- ${n}`).join('\n') : '- Not listed in transcript'}\n\n## Next Meeting\n${nextMeeting || '- Not specified'}\n\n## Adjournment\n- ${detectAdjourn(lines) || 'Adjournment time not detected'}\n`;
      const stamps = extractTimestampLines(lines);
      if (stamps.length) {
        const bullets = stamps.slice(0, 15).map((s) => {
          const sec = toSeconds(s.ts);
          const url = sec != null ? `https://youtube.com/watch?v=${meta.videoId}&t=${sec}s` : `https://youtube.com/watch?v=${meta.videoId}`;
          return `- [${s.ts}](${url}) ‚Äî ${s.text.replace(/[\\*\[\]\(\)_#>]/g, '')}`;
        }).join('\n');
        md += `\n## Timeline\n${bullets}\n`;
      }
      return md;
    }

    async function exportMinutesDocx(){
      if (!window.docx) { showStatus('DOCX library not loaded.', 'error'); return; }
      const { Document, Packer, Paragraph, HeadingLevel, TextRun } = docx;
      const text = document.getElementById('minutesText').value || '';
      const lines = text.split(/\r?\n/);
      const doc = new Document({});
      const children = [];
      for (const line of lines){
        if (!line.trim()) { children.push(new Paragraph({ text: '' })); continue; }
        if (line.startsWith('# ')) children.push(new Paragraph({ text: line.replace(/^#\s+/, ''), heading: HeadingLevel.HEADING_1 }));
        else if (line.startsWith('## ')) children.push(new Paragraph({ text: line.replace(/^##\s+/, ''), heading: HeadingLevel.HEADING_2 }));
        else if (line.startsWith('### ')) children.push(new Paragraph({ text: line.replace(/^###\s+/, ''), heading: HeadingLevel.HEADING_3 }));
        else if (line.startsWith('- ')) children.push(new Paragraph({ text: line.replace(/^-+\s*/, ''), bullet: { level: 0 } }));
        else if (/^\*\*(.+)\*\*$/.test(line)) children.push(new Paragraph({ children: [ new TextRun({ text: line.replace(/^\*\*|\*\*$/g, ''), bold: true }) ] }));
        else children.push(new Paragraph({ text: line }));
      }
      doc.addSection({ children });
      const blob = await Packer.toBlob(doc);
      triggerDownload(blob, `${(__minutesCurrent?.title || 'minutes')}.docx`);
    }

    function mdToHtml(md){
      let out = md;
      out = out.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      out = out.replace(/^###\s+(.*)$/gm,'<h3>$1<\/h3>');
      out = out.replace(/^##\s+(.*)$/gm,'<h2>$1<\/h2>');
      out = out.replace(/^#\s+(.*)$/gm,'<h1>$1<\/h1>');
      out = out.replace(/\*\*(.+?)\*\*/g,'<strong>$1<\/strong>');
      out = out.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1<\/a>');
      out = out.replace(/^- (.*)$/gm,'<li>$1<\/li>');
      out = out.replace(/(<li>[\s\S]*?<\/li>)/gm,'<ul>$1<\/ul>');
      out = out.replace(/^(?!<h\d>|<ul>|<li>|<\/li>|<\/ul>|<strong>|<a ).+$/gm, '<p>$&<\/p>');
      return out;
    }
    function exportMinutesPdf(){
      if (typeof html2pdf === 'undefined') { showStatus('PDF library not loaded.', 'error'); return; }
      const md = document.getElementById('minutesText').value || '';
      const html = mdToHtml(md);
      const temp = document.createElement('div');
      temp.style.padding = '20px'; temp.style.background = '#ffffff'; temp.style.color = '#111827'; temp.innerHTML = html;
      document.body.appendChild(temp);
      html2pdf().from(temp).set({ margin: 10, filename: `${(__minutesCurrent?.title || 'minutes')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' } }).save().then(()=>{ document.body.removeChild(temp); }).catch(()=>{ document.body.removeChild(temp); });
    }
    function triggerDownload(blob, filename){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    function generateMinutes(transcriptId){
      const t = transcripts.find((x) => x.id === transcriptId);
      if (!t) { showStatus('Could not find transcript to summarize.', 'error'); return; }
      const text = (t.transcript || '').replace(/\s+\n/g, '\n').trim();
      const minutes = makeMinutesDraft(t, text);
      __minutesCurrent = { id: t.id, title: t.title };
      const box = document.getElementById('minutesText');
      if (box) box.value = minutes;
      openMinutesModal();
    }

    // Autosave
    (function(){
      document.addEventListener('input', (e) => { if (e.target && e.target.id === 'minutesText') { try { const key = `osgt_minutes_${__minutesCurrent?.id || 'draft'}`; const meta = `osgt_minutes_meta_${__minutesCurrent?.id || 'draft'}`; localStorage.setItem(key, e.target.value); localStorage.setItem(meta, JSON.stringify({ title: __minutesCurrent?.title || 'Draft', ts: Date.now() })); const s = document.getElementById('minutesSaveStatus'); if (s) { s.textContent = 'Saved'; setTimeout(() => { s.textContent = ''; }, 1500); } } catch {} } });
    })();

    // ========= Find Channel (backend) =========
    async function findGovChannel(){
      const town = (document.getElementById('townInput')?.value || '').trim();
      const state = (document.getElementById('stateInput')?.value || '').trim();
      if (!town || !state) { showStatus('Please enter both town/city and state to find the channel.', 'error'); return; }
      showStatus(`Searching for official channel for ${town}, ${state}...`, 'info');
      try {
        const url = `${BACKEND_URL}?action=findGovChannel&town=${encodeURIComponent(town)}&state=${encodeURIComponent(state)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Backend error: ${res.status}`);
        const data = await res.json();
        const candidates = data && data.candidates ? data.candidates : (data && data.channelId ? [{ channelId: data.channelId, title: data.title, description: data.description, thumbnailUrl: data.thumbnailUrl }] : []);
        if (!candidates.length) { showStatus('No likely government channel found. You can paste a channel URL manually.', 'error'); return; }
        if (candidates.length === 1) {
          document.getElementById('channelUrl').value = `https://www.youtube.com/channel/${candidates[0].channelId}`;
          showStatus(`Found: ${candidates[0].title || 'Channel'} ‚Ä¢ ${candidates[0].channelId}. You can now Fetch Transcripts.`, 'success');
        } else {
          showChannelCandidates(candidates.slice(0, 3));
          showStatus('Multiple candidates found ‚Äî pick the best match.', 'info');
        }
      } catch (e) { showStatus(`Find channel failed: ${e.message}`, 'error'); }
    }

    function showChannelCandidates(cands){
      const wrap = document.getElementById('channelCandidates');
      if (!wrap) return; wrap.innerHTML = !cands?.length ? '<div class="empty-state">No suitable channels found.</div>' : cands.map((c) => `
        <div class="card" style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
          <img src="${c.thumbnailUrl || ''}" alt="" style="width:64px;height:64px;border-radius:10px;border:1px solid var(--border);object-fit:cover;" />
          <div style="flex:1;">
            <div class="card-title" style="margin:0;">${c.title || 'Channel'}</div>
            <div style="color:var(--text-dim); font-size:.9rem; margin-top:4px;">${c.description || ''}</div>
          </div>
          <button class="btn-primary" onclick="selectChannel('${String(c.channelId).replace(/`/g,'\`')}')">Select</button>
        </div>`).join('');
      document.getElementById('channelModal').classList.add('active');
    }
    function closeChannelModal(){ document.getElementById('channelModal').classList.remove('active'); }
    function selectChannel(channelId){ if (!channelId) return; document.getElementById('channelUrl').value = `https://www.youtube.com/channel/${channelId}`; closeChannelModal(); showStatus(`Selected channel: ${channelId}`, 'success'); }

    // ========= Fetch flow =========
    async function fetchTranscripts(){
      const channelUrl = document.getElementById('channelUrl').value;
      if (!channelUrl) { const t = (document.getElementById('townInput')?.value || '').trim(); const s = (document.getElementById('stateInput')?.value || '').trim(); if (t && s) { await findGovChannel(); } }
      const dateRange = document.getElementById('dateRange').value;
      const url = document.getElementById('channelUrl').value;
      if (!url) { showStatus('Please enter a valid YouTube channel URL', 'error'); return; }

      showLoading(true); showStatus('Extracting channel information...', 'info');
      try {
        const channelInfo = extractChannelInfo(url);
        if (!channelInfo) throw new Error('Invalid YouTube channel URL format');
        showStatus('Searching for town meeting videos...', 'info');
        const videos = await fetchChannelVideos(channelInfo, dateRange);
        showStatus(`Found ${videos.length} videos. Processing transcripts...`, 'info');
        transcripts = [];
        for (let i = 0; i < videos.length; i++) {
          const video = videos[i];
          showStatus(`Processing video ${i + 1} of ${videos.length}: ${video.title}`, 'info');
          try { const transcriptData = await processVideoTranscript(video); if (transcriptData) transcripts.push(transcriptData); } catch (e) { console.warn('Could not process transcript for', video.title, e); }
        }
        showStatus(`Successfully processed ${transcripts.length} transcripts from ${videos.length} videos`, 'success');
        renderTranscripts(); updateBoardFilters(); refreshAds(document);
      } catch (e) { showStatus(`Error: ${e.message}`, 'error'); console.error(e); }
      finally { showLoading(false); }
    }

    // ========= Search input (debounced) =========
    let _searchTimer = null;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const q = e.target.value;
      clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => searchTranscripts(q), 250);
    });

    function searchTranscripts(query){
      if (!query.trim()) { renderTranscripts(); return; }
      const results = transcripts.filter((t) => `${t.title} ${t.description} ${t.transcript}`.toLowerCase().includes(query.toLowerCase()));
      const grid = document.getElementById('transcriptGrid');
      if (!results.length){ grid.innerHTML = `<div class=\"empty-state\"><h3>No results found</h3><p>No transcripts match your search for \"${query}\"</p></div>`; return; }
      const tmp = transcripts; transcripts = results; renderTranscripts(); transcripts = tmp; // restore
    }

    // ========= Wire buttons =========
    document.getElementById('btnFindChannel').addEventListener('click', findGovChannel);
    document.getElementById('btnFetch').addEventListener('click', fetchTranscripts);
    document.getElementById('btnExport').addEventListener('click', exportData);
    document.getElementById('btnGenMinutes').addEventListener('click', () => { if (lastViewedTranscriptId) generateMinutes(lastViewedTranscriptId); else showStatus('Open a transcript first.', 'error'); });

    // ========= Export Data =========
    function exportData(){
      if (!transcripts.length) { showStatus('No data to export. Please fetch transcripts first.', 'error'); return; }
      const exportModal = document.createElement('div');
      exportModal.className = 'modal active';
      exportModal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">Export Options</h2>
            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="padding: 20px 18px;">
            <div style="margin-bottom: 20px;">
              <label style="display:block; margin-bottom:10px; font-weight:600;">Export Format:</label>
              <select id="exportFormat" style="width:100%; padding:10px; border:1px solid var(--border); background:var(--elev); color:var(--text); border-radius:8px;">
                <option value="csv">CSV (Spreadsheet)</option>
                <option value="json">JSON (Data)</option>
                <option value="txt">TXT (Plain Text)</option>
                <option value="md">Markdown (Documentation)</option>
              </select>
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display:block; margin-bottom:10px; font-weight:600;">Include:</label>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:normal;"><input type="checkbox" id="includeTranscripts" checked /> Full Transcripts</label>
                <label style="display:flex; align-items:center; gap:8px; font-weight:normal;"><input type="checkbox" id="includeMetadata" checked /> Video Metadata</label>
                <label style="display:flex; align-items:center; gap:8px; font-weight:normal;"><input type="checkbox" id="includeStats" checked /> View Statistics</label>
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top: 30px;">
              <button id="btnDoExport" style="flex:1; padding:12px; background: var(--accent); color:#0b0f17; border:none; border-radius:8px; cursor:pointer; font-weight:600;">üìä Export Data</button>
              <button onclick="this.closest('.modal').remove()" style="flex:1; padding:12px; background:#f8f9fa; color:#495057; border:1px solid #dee2e6; border-radius:8px; cursor:pointer;">Cancel</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(exportModal);
